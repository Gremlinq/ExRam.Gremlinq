name: Check pull request

on:
  pull_request:
  workflow_call:

jobs:

  test-linux:
    runs-on: ubuntu-latest
    if: ${{ github.event.pull_request.head.repo.fork || github.event.pull_request.title != 'Prepare release' }}

    steps:
    - name: Checkout
      uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 #4.1.14
      with:
        fetch-depth: 0
        submodules: 'true'

    - name: Setup .NET
      uses: actions/setup-dotnet@4d6c8fcf3c8f7a60068d26b594648e99df24cee3 # 4.0.0
      with:
        global-json-file: global.json

    - name: Build
      run: dotnet build  -c Release ./${{ github.event.repository.name }}.sln
      
    - name: Test
      run: dotnet test -c Release --no-build --collect:"XPlat Code Coverage;Format=opencover" ./${{ github.event.repository.name }}.sln 
      env:
        RunGremlinServerIntegrationTests: 'true'
        RunJanusGraphIntegrationTests: 'true'
        RunNeptuneIntegrationTests: 'true'

    - name: Collect coverage
      uses: codecov/codecov-action@125fc84a9a348dbcf27191600683ec096ec9021c # 4.4.1
      with:
        token: ${{ secrets.CODECOV_TOKEN }}

  test-windows:
    runs-on: windows-2022
    if: ${{ github.event.pull_request.head.repo.fork || github.event.pull_request.title != 'Prepare release' }}

    steps:
    - name: Checkout
      uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 #4.1.14
      with:
        fetch-depth: 0
        submodules: 'true'
        
    - name: Setup .NET
      uses: actions/setup-dotnet@4d6c8fcf3c8f7a60068d26b594648e99df24cee3 # 4.0.0
      with:
        global-json-file: global.json

    - name: Start CosmosDb Emulator
      uses: janpio/cosmos-emulator-github-action@8c35a1bfde25fc32234c163c044322af3f2e56e3
      with:
          parameter_string: "-EnableGremlin"

    - name: Build
      run: dotnet build  -c Release ./${{ github.event.repository.name }}.sln
      
    - name: Test
      run: dotnet test -c Release --no-build --collect:"XPlat Code Coverage;Format=opencover" ./${{ github.event.repository.name }}.sln
      env:
        RunCosmosDbIntegrationTests: 'true'
        
    - name: Collect coverage
      uses: codecov/codecov-action@125fc84a9a348dbcf27191600683ec096ec9021c # 4.4.1
      with:
        token: ${{ secrets.CODECOV_TOKEN }}